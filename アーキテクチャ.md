# アーキテクチャ（ドラフト）
## 1. 全体像
[Browser]
- Markdown Editor (Monaco/CodeMirror)
- Preview Renderer (Marp core / iframe)
- Local Storage (drafts, settings: folderId)
- Google OAuth (PKCE)

        | (Export リクエスト: md/css/assets)
        v

[Backend API]
- Auth callback (optional) / token exchange (if needed)
- Export Job API (enqueue)
- Worker (Marp CLI実行でPPTX/PDF生成)
- Google Drive Upload + Convert（Slides出力時）
- Result URL / Download URL 返却

## 2. コンポーネント詳細
### 2.1 フロントエンド
- Editor
  - Markdown入力
  - テンプレ挿入（2カラム/図解/ラベル）
  - 文字量チェック（ルールベース）→警告
- Preview
  - marp-coreでHTML生成して表示（テーマ/CSS適用）
- Export
  - Google OAuth（Driveに書き込む権限）
  - 保存先フォルダ選択（Drive Picker）
  - Export開始→進捗表示（ポーリング）→完了リンク表示

#### OAuthトークンフロー（採用方式）
1. フロントエンドがPKCEでアクセストークンを取得（クライアントサイド）
2. Exportリクエスト時に md/css/folderId をボディに、**アクセストークンを Authorization ヘッダーに含めて送信**
3. バックエンドはそのトークンを使い Drive API を呼び出す（サーバー側でトークンを永続保存しない。ログミドルウェアでヘッダーをマスクすること）
4. トークンの有効期限切れ時はフロントがリフレッシュして再送

> セキュリティ: 通信はHTTPS必須。バックエンドはトークンをメモリ内のみで使用し、DBやログに残さない。

### 2.2 バックエンド（エクスポート専用）
- Export API
  - 入力（md, css, asset refs, format, folderId?, filename）
  - format: "slides"（Google Slides）| "pdf"
  - ジョブ登録（jobId発行）
- Worker
  - md/cssを一時ディレクトリに展開
  - format="slides" の場合:
    - Marp CLIでPPTX生成
    - Drive APIでアップロード（指定フォルダ、mimeType: application/vnd.google-apps.presentation を指定しアップロード時変換）
    - APIレスポンスで変換完了を検知（別途ポーリング不要）
    - 生成したSlidesのURLを保存→ジョブステータスを "done" に更新
  - format="pdf" の場合:
    - Marp CLI `--pdf` でPDF生成
    - 生成ファイルをダウンロードURL経由で返却（Drive連携不要）
    - ジョブステータスを "done" に更新（downloadUrl を含む）
  - 画像取得制限:
    - httpsスキームのみ許可
    - DNS解決後のIPアドレスを検証（RFC1918、リンクローカル、ループバックを拒否）
    - クラウドメタデータエンドポイント（169.254.169.254）を明示的にブロック
    - リダイレクト先URLも同一ルールで再検証（最大リダイレクト回数: 3）
  - 画像タイムアウト: 1件あたり5秒、合計15秒
  - カスタムCSS: Allowed Propertiesリストで検証後にMarp CLIへ渡す（url(), expression(), import 等の禁止）
- Storage
  - 一時ファイル TTL: ジョブ完了後即削除（成功/失敗問わず）、最大保持30分（バッチで削除）
  - ジョブ状態レコード TTL: 7日（ユーザーが完了URLを確認できる猶予）
  - ジョブ状態（DB/Redis等）

## 3. データフロー（エクスポート）
### 3.1 Google Slides出力
1) User clicks Export → "Google Slides" を選択
2) OAuth consent（初回）+ folder choose（初回/変更時）
3) Frontend sends md/css + folderId + format="slides"（Authorization ヘッダーにトークン）
4) Backend enqueues job → jobId を返却
5) Frontend polls /jobs/{jobId}/status（3秒間隔、最大5分）
6) Worker generates PPTX via Marp CLI
7) Worker uploads PPTX to Drive（mimeType指定で Slides に変換）
8) Worker saves slides URL → ジョブステータスを "done" に更新
9) Frontend receives { status: "done", slidesUrl } → リンク表示
   - "error" の場合: エラーメッセージ＋再試行ボタン
   - 再試行時は既存jobIdのステータスを先に確認し、二重ジョブを防止

### 3.2 PDF出力
1) User clicks Export → "PDF" を選択
2) Frontend sends md/css + format="pdf"（OAuth不要）
3) Backend enqueues job → jobId を返却
4) Frontend polls /jobs/{jobId}/status（3秒間隔、最大5分）
5) Worker generates PDF via Marp CLI `--pdf`
6) Worker saves downloadUrl → ジョブステータスを "done" に更新
7) Frontend receives { status: "done", downloadUrl } → ダウンロードリンク表示

## 4. 方式選定メモ
- 見た目重視・実装速度優先：PPTX→Drive変換方式（本プロジェクト採用）
- 編集可能性を最大化：Slides APIでネイティブ生成（将来拡張）
- 機密最優先：ローカル完結（Tauri/Electron）でMarp CLIをローカル実行（将来拡張）

## 5. リスクと対策
- 変換崩れ：テンプレ制約（文字量/余白/装飾）で抑える、崩れ検知の警告UI
- フォント差：推奨フォントを固定、代替フォントでも崩れにくい余白設計
- 画像：アップロード/参照方式で崩れ差が出るため、MVPはURL中心、必要時のみアップロード
- 同時変換負荷：ジョブキュー＋ワーカー水平スケール