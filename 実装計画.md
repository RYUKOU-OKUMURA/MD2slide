# MD2slide 実装計画書

## Context

MD2slideはグリーンフィールドプロジェクトで、設計ドキュメント3件（要件定義.md、アーキテクチャ.md、技術スタック.md）のみが存在する。本計画はPhase 0（PoC検証）からPhase 10（テスト・品質保証）まで段階的に実装を進め、各フェーズのタスクをチェックボックスで管理する。

---

## Phase 0: PoC検証

**目的:** MVP開発のGo/No-Go判断

- [x] **PoC-1: Marp CLI → Google Slides 変換品質検証**
  - [x] marp-cliインストール、2カラム/図解サンプルMarkdown作成
  - [x] `marp --pptx` でPPTX生成
  - [ ] Google DriveでSlides変換、目視確認（列幅±5%、フォント適用）— ユーザー手動確認
  - [x] 結果を `poc-results.md` に記録
- [ ] **PoC-2: `drive.file` スコープ + Picker検証**
  - [ ] GCP OAuthクライアントID・Picker APIキー取得 — ユーザー依存
  - [x] 最小HTMLでPKCEフロー実装
  - [ ] Pickerフォルダ選択 → Driveアップロード+Slides変換の動作確認 — ユーザー依存
  - [x] 結果を記録
- [x] **PoC-3: Workerコンテナ計測**
  - [x] Dockerfile作成（node:20-slim + Chromium + marp-cli + Noto Sans JP）
  - [x] 変換時間計測（9スライド、PPTX: 2.18秒 / PDF: 1.80秒）
  - [ ] Cloud Runコールドスタート計測（min-instances=0 vs 1）— 要デプロイ
  - [x] 結果を記録
- [x] **Go/No-Go判断** — Phase 1開始可能

---

## Phase 1: プロジェクト初期設定

**目的:** monorepo構成・開発環境・CI基盤

- [x] pnpmワークスペース初期化（`packages/frontend`, `packages/backend`, `packages/shared`）
- [x] ルート `package.json` にワークスペーススクリプト定義
- [x] TypeScript共通設定（`tsconfig.base.json` strict: true）
- [x] 各パッケージの `tsconfig.json`
- [x] `packages/shared/types/` に共通型定義（`job.ts`, `api.ts`）
- [x] ESLint flat config + Prettier設定
- [x] `lint-staged` + `husky` pre-commitフック
- [x] `.gitignore`, `.env.example`
- [x] GitHub Actions CI（`.github/workflows/ci.yml` — lint, type-check, test）
- [x] `docker/worker/Dockerfile`（Chromium + marp-cli + Noto Sans JP）
- [x] `docker-compose.yml`（Worker + PostgreSQL）
- [x] Vitest設定（ルート + 各パッケージ）

---

## Phase 2: フロントエンド基盤（エディタ + プレビュー）

**目的:** Markdownエディタとリアルタイムプレビュー（エクスポートなし）

- [ ] Next.js 14 (App Router) セットアップ + Tailwind CSS
- [ ] レイアウトコンポーネント（`app/layout.tsx`）
- [ ] CodeMirror 6エディタ統合（`components/editor/MarkdownEditor.tsx`）
  - [ ] Markdown構文ハイライト + Marpディレクティブ対応
  - [ ] Undo/Redo対応
- [ ] Marpプレビューレンダラー（`lib/marp/renderer.ts` + `components/preview/SlidePreview.tsx`）
  - [ ] 16:9固定、デバウンス300ms
  - [ ] スライドページネーション（前/次）
- [ ] エディタ+プレビュー分割レイアウト（リサイズ可能スプリットペイン）
- [ ] ローカル保存（LocalStorage、自動保存3秒デバウンス、起動時復元）
- [ ] テスト（エディタレンダリング、renderer単体、自動保存/復元）

---

## Phase 3: バックエンド基盤（エクスポートAPI + Worker）

**目的:** ジョブAPI + Marp CLI Worker（Drive連携なし）

- [ ] Fastifyサーバー初期化（`src/server.ts`）+ CORS, ヘルスチェック
- [ ] 環境変数管理（dotenv + zodバリデーション、`src/config.ts`）
- [ ] `POST /api/export` エンドポイント（zodスキーマバリデーション、jobId発行）
- [ ] `GET /api/jobs/:jobId/status` エンドポイント
- [ ] ジョブキュー抽象化インターフェース（`src/queue/interface.ts`）
- [ ] インメモリキュー実装（`src/queue/inMemoryQueue.ts`）
- [ ] PostgreSQLスキーマ定義（Drizzle ORM、`jobs`テーブル）+ マイグレーション
- [ ] Marp CLIラッパー（`src/worker/marpConverter.ts` — PPTX/PDF生成、3分タイムアウト）
- [ ] ジョブプロセッサ（`src/worker/processor.ts`）
- [ ] CSS検証（`src/security/cssValidator.ts` — ホワイトリスト方式）
- [ ] 画像URL検証（`src/security/imageUrlValidator.ts` — SSRF対策）
- [ ] 一時ファイル管理（`src/worker/tempFileManager.ts` — 即時削除+30分バッチ削除）
- [ ] PDFダウンロードエンドポイント（`GET /api/download/:jobId`）
- [ ] テスト（API統合、marpConverter単体、セキュリティバリデータ単体）

---

## Phase 4: Google連携（OAuth + Drive + Picker）

**目的:** 認証・フォルダ選択・Driveアップロード+Slides変換

- [ ] Google OAuth PKCE実装（`lib/auth/googleAuth.ts` — verifier生成、認可URL、token交換）
- [ ] トークン管理（`lib/auth/tokenManager.ts` — sessionStorage、自動リフレッシュ）
- [ ] ログイン/ログアウトUI（`components/auth/LoginButton.tsx` + `hooks/useAuth.ts`）
- [ ] Google Picker統合（`lib/google/pickerLoader.ts` + `components/google/FolderPicker.tsx`）
- [ ] フォルダID保存（LocalStorage、初回表示+設定変更UI）
- [ ] Drive APIクライアント（`src/google/driveClient.ts` — Resumable upload + mimeType変換）
- [ ] トークン検証（`src/google/tokenValidator.ts` — 形式チェック、ログマスク）
- [ ] Worker拡張: format="slides"時のDrive連携統合
- [ ] テスト（OAuthフロー、Drive APIモック、Picker、トークンリフレッシュ）

---

## Phase 5: テンプレートシステム

**目的:** P1→P2→P3の順にテンプレート実装

- [ ] テンプレート型定義（`lib/templates/types.ts`）+ レジストリ（`registry.ts`）+ 挿入ロジック（`inserter.ts`）
- [ ] **P1: 2カラムテンプレート**
  - [ ] Markdown/CSS定義（左58%/右42%グリッド）
  - [ ] 文字量チェックバリデータ（最大行数/文字数、超過警告）
- [ ] **P2: 図解テンプレート3種**
  - [ ] 3ボックス横並び
  - [ ] 縦フロー（3-5ステップ）
  - [ ] Before/After（2ボックス+矢印）
- [ ] **P3: ラベル/バッジ**
  - [ ] テキストラベル
  - [ ] 角丸バッジ
- [ ] テンプレート選択パネルUI（`TemplatePanel.tsx` + `TemplateCard.tsx`、カテゴリタブ）
- [ ] ツールバーにテンプレ挿入ボタン追加
- [ ] テスト（各テンプレ出力、バリデータ、PPTX/PDF変換品質の手動確認）

---

## Phase 6: エクスポート統合（フルフロー）

**目的:** フロントエンド→バックエンド→Drive/PDFのE2E接続

- [ ] エクスポートボタン（`ExportButton.tsx` — ドロップダウン: Google Slides / PDF）
- [ ] エクスポートダイアログ（`ExportDialog.tsx` — 認証チェック、フォルダ選択、ファイル名入力）
- [ ] 進捗表示（`ExportProgress.tsx` — ステップインジケーター）
- [ ] ポーリングフック（`hooks/useExportJob.ts` — 3秒間隔、5分タイムアウト、二重ジョブ防止）
- [ ] APIクライアント（`lib/api/exportClient.ts`）
- [ ] 完了時UI（`ExportResult.tsx` — Slides「開く」ボタン / PDFダウンロードボタン）
- [ ] エラーハンドリングUI（`ExportError.tsx` — ケース別メッセージ+再試行ボタン）
- [ ] テスト（E2Eフロー、ポーリング、タイムアウト、エラーケース）

---

## Phase 7: PDF出力最適化

**目的:** PDF固有の最適化と品質確認

- [ ] marpConverter PDF固有設定（`--allow-local-files`, `--no-sandbox`、品質設定）
- [ ] ダウンロードエンドポイント完成（Content-Type/Disposition、一時ファイル削除）
- [ ] フロントのPDFダウンロードボタン完成
- [ ] PDF品質検証（各テンプレ、日本語フォント埋め込み、画像含むスライド）
- [ ] テスト（PDF生成統合、ダウンロードストリーミング、大規模Markdown 20スライド+）

---

## Phase 8: UI/UX仕上げ

**目的:** エディタ体験向上・全体ポリッシュ

- [ ] Marpディレクティブ補完（`---` スライド区切り等）
- [ ] ツールバー（太字/斜体/リスト/コードブロック/画像URLショートカット）
- [ ] スライド数カウンター
- [ ] テーマ/CSS切り替えUI
- [ ] 画像URL挿入ダイアログ（不正URL警告付き）
- [ ] IndexedDB複数ドキュメント管理（一覧、切り替え、削除、最終保存時刻）
- [ ] ヘッダー（ロゴ、ドキュメント名編集、認証状態）
- [ ] 設定パネル（デフォルトフォルダ変更、テーマ選択）
- [ ] トースト通知システム
- [ ] キーボードショートカット（Ctrl+S, Ctrl+E等）
- [ ] アクセシビリティ（フォーカス管理、aria-label、キーボードナビゲーション）
- [ ] テスト（UIスナップショット、IndexedDB、ショートカット）

---

## Phase 9: インフラ・デプロイ

**目的:** 本番環境セットアップ・CI/CD完成

- [ ] Vercelデプロイ（環境変数、ドメイン、PRプレビュー）
- [ ] Cloud Runデプロイ（メモリ2GB、タイムアウト300秒、min-instances=1）
- [ ] Cloud SQL (PostgreSQL) セットアップ + VPCコネクタ
- [ ] CI/CD完成（`.github/workflows/deploy-frontend.yml`, `deploy-worker.yml`）
- [ ] 環境分離（staging / production）
- [ ] Observability（Cloud Logging、Sentry統合、ジョブ監視）
- [ ] セキュリティ（CORS制限、Rate Limiting、セキュリティヘッダー）

---

## Phase 10: テスト・品質保証

**目的:** E2Eテスト・変換品質検証・リリース準備

- [ ] Playwright E2Eセットアップ + Docker Composeローカル環境
- [ ] E2Eテストケース（エディタ→プレビュー、テンプレート挿入、PDFエクスポート、Slidesエクスポート、エラーケース）
- [ ] 変換品質マトリクス検証（各テンプレ x 各出力形式）
  - [ ] P1 2カラム: 列幅±5%
  - [ ] P2 図解: ボックス/テキスト対応
  - [ ] フォント: Noto Sans JP適用
  - [ ] 不許容: テキストあふれ、図解重なり
- [ ] パフォーマンステスト（変換時間、同時リクエスト、Lighthouseスコア）
- [ ] セキュリティテスト（SSRF、CSSインジェクション、トークンログ非出力、一時ファイル削除）
- [ ] リリースドキュメント（README.md、環境変数ドキュメント、既知の制限）

---

## フェーズ間依存関係

```
Phase 0 (PoC) ── Go判断 ──→ Phase 1 (初期設定)
                              │
                              ├──→ Phase 2 (FE基盤)  ──→ Phase 5 (テンプレート)
                              │                                    │
                              ├──→ Phase 3 (BE基盤)  ──→ Phase 7 (PDF最適化)
                              │       │                            │
                              │       └──→ Phase 4 (Google連携)    │
                              │               │                    │
                              │               └────────────────────┘
                              │                         │
                              │                   Phase 6 (エクスポート統合)
                              │                         │
                              │               ┌─────────┼─────────┐
                              │               v         v         v
                              │         Phase 8     Phase 9    Phase 10
                              │        (UI/UX)    (インフラ)   (テスト)
```

**並行可能:** Phase 2 と Phase 3 / Phase 5 と Phase 7 / Phase 8, 9, 10
