# 要件定義書（ドラフト）
## 1. 背景・目的
- Marp（Markdown）ベースでスライドを作り、Webアプリ上で編集・プレビューできるようにする
- ワンクリックで Googleドライブへ出力し、最終成果物は Googleスライドとして編集可能にする
- デザインは「2カラム（最優先）」「図解」「ラベル」の順にテンプレ化し、崩れにくさと編集性を両立する

## 2. 想定ユーザー・利用シーン
- セミナー/社内勉強会/講義用の資料を短時間で作る
- エクスポート後は Googleスライド上で共同編集・最終調整する

## 3. スコープ
### 3.0 MVP開始前提条件（PoC）
以下を本開発着手前に検証し、Go/No-Go を判断する。
- [ ] Marp CLIでPPTX生成 → Google DriveでSlides変換し、2カラム・図解テンプレの崩れを目視確認 — 結果:（　）/ 日付:（　）
- [ ] `drive.file` スコープのみでPicker選択フォルダへのアップロード＋変換が可能か検証 — 結果:（　）/ 日付:（　）
- [ ] Worker（Chromium同梱コンテナ）のコールドスタート時間と変換所要時間の計測 — 時間:（　秒）/ 日付:（　）

### 3.1 MVP（最小実用）
- Web上のMarkdownエディタ（Marp互換の記法）＋リアルタイムプレビュー
- テンプレ（優先順位 P1 → P2 → P3）
  - P1: 2カラム（固定比率・制約付き）
  - P2: 図解テンプレ（3種）
  - P3: ラベル（まずはテキスト、後でバッジ）
- エクスポート
  - Google Slides出力（メイン）: PPTX生成 → Driveアップロード → Slides変換 → リンク返却
  - PDF出力: Marp CLI `--pdf` で生成 → ブラウザから直接ダウンロード
  - オプション: PPTXも同フォルダに残す（再変換・バックアップ用）
  - ユーザーがフォルダ選択可能（Google Slides/PPTX出力時）

### 3.2 将来拡張（MVP外）
- HTML出力
- 変換後のGoogleスライドへ軽い「整形」適用（タイトルスタイル統一など）
- チーム共有テンプレ、テンプレマーケット
- オフライン/ローカル完結（Tauri/Electron）
- AI生成（章立て・下書き生成等）

## 4. 機能要件
### 4.1 編集体験
- Markdown入力（Marp互換）
- スライドプレビュー（16:9前提）
- CSS/テーマ適用（MVPでは提供テンプレに限定 or 1枚のカスタムCSS）
- 画像挿入
  - MVP: URL貼り付けのみ
  - MVP後期: クリップボードペースト（Base64埋め込み or フロント一時アップロード）
  - 制約: Worker側でfetch可能なのはhttpsスキームのみ（SSRF対策）
- 履歴（Undo/Redo）/ 自動保存（ブラウザローカル保存）

### 4.2 レイアウトテンプレ（優先順位 P1 → P2 → P3）
#### P1: 2カラム（最優先）
- 2カラム比率固定（例：左58% / 右42%）
- 左：見出し＋本文/箇条書き
- 右：カード（短文）/画像/図解（いずれか）
- 制約
  - 最大行数・最大文字量（溢れそうなら警告表示）
  - 行間・フォント固定
  - 影・グラデ・複雑な背景は禁止（崩れ防止）

#### P2: 図解（テンプレ化）
- 図解テンプレ3種
  1) 3ボックス横並び（例：Human / AI / Output）
  2) 縦フロー（3〜5ステップ）
  3) Before/After（2ボックス＋矢印）
- 原則「箱＋線＋テキスト」で表現（SVG一枚絵は極力避ける）

#### P3: ラベル/バッジ（後回し）
- MVP：小さなテキストラベル
- 追加：角丸バッジ（塗り＋角丸＋余白、短文固定）

### 4.3 エクスポート出力
#### Google Slides出力
- OAuth認可
- ユーザーが保存先フォルダを選択（初回 or 設定で変更可能）
- PPTX生成 → Driveにアップロード（parents=folderId）
- Drive上でGoogleスライドへ変換（結果はSlides形式）
- 返却
  - GoogleスライドのURL
  - オプション：PPTXダウンロードURL/DriveファイルURL

#### PDF出力
- Marp CLI `--pdf` で生成（Chromiumによるレンダリング）
- サーバからブラウザへ直接ダウンロード（Drive連携不要、OAuth不要）
- Google Slides出力と同一ジョブAPI経由（format パラメータで切り替え）

#### ジョブ完了通知方式（MVP）
- **ポーリング方式**（3秒間隔、最大5分）
- 5分超過でタイムアウトエラー表示＋再試行ボタン
- 再試行時は既存jobIdのステータスを先に確認し、二重ジョブを防止
- 完了時:
  - Google Slides: スライドURLと「開く」ボタンを表示
  - PDF: ダウンロードリンクを表示

## 5. 非機能要件
### 5.1 品質
- 変換後の「見た目のそれっぽさ」を優先（完璧一致は保証しない）
- 2カラムと図解テンプレは崩れにくさを最優先で設計

#### 変換品質の受入基準（MVP）
- P1 2カラムテンプレ: 左右分割が崩れないこと（列幅は±5%まで許容）
- P2 図解テンプレ: ボックスとテキストが視覚的に対応していること
- フォント: Noto Sans JP が Slides 上で適用されていること（代替フォントへの置換は許容）
- 許容不可: テキストが別スライドへあふれる、図解が重なって読めない

### 5.2 セキュリティ/プライバシー
- スライド本文（MD/CSS）は基本ブラウザローカル保存（MVP）
- エクスポート時のみサーバへ送信（サーバ変換方式の場合）
- OAuthトークンの安全な保管（短期トークン＋リフレッシュトークン運用は最小権限で）
- 取り扱い注意：機密情報を想定する場合はローカル完結版の検討

### 5.3 可用性/運用
- 変換処理はキュー/ジョブ管理（同時実行数制限、タイムアウト、再試行）
- 生成物の寿命（サーバ一時ファイルは短時間で削除）

#### エラーケース対応（最低限）
| ケース | ユーザーへの表示 |
|---|---|
| Marp CLI変換失敗 | 「変換に失敗しました。内容を確認してください」＋詳細ログ |
| Drive アップロード失敗 | 「Driveへの保存に失敗しました。権限を確認してください」 |
| Drive 変換失敗 | 「Slidesへの変換に失敗しました。PPTXをダウンロードしてください」 |
| PDF生成失敗 | 「PDF生成に失敗しました。内容を確認してください」 |
| タイムアウト（5分） | 「変換に時間がかかっています。再試行してください」 |

## 6. 画面/UX要件（最低限）
- エディタ：Markdown（左）/ プレビュー（右）
- テンプレ挿入：2カラム、図解（3種）、ラベル
- Exportボタン：出力形式選択（Google Slides / PDF）
  - Google Slides: 初回フォルダ選択 → 以後は同じフォルダ（変更UIあり）
  - PDF: フォルダ選択不要、即ダウンロード
- Export完了：Google Slidesは「開く」リンク、PDFはダウンロードリンク

## 7. 成果物定義
- Googleスライド（メイン出力）
- PDF（ダウンロード出力）
- PPTX（任意で残す）
- 変換ログ（ユーザーには簡易ステータス表示）